---
name: compound-docs
description: Capture solved problems as categorized documentation with YAML frontmatter for fast lookup
allowed-tools:
  - Read # Parse conversation context
  - Write # Create rule files
  - Bash # Create directories, check existing categories
  - Grep # Search existing rules
  - AskUserQuestion # Interactive scope selection
preconditions:
  - Problem has been solved (not in-progress)
  - Solution has been verified working
---

# compound-docs Skill

**Purpose:** Document learnings from solved problems directly to Claude Code's native memory system. Creates searchable rules that compound your team's knowledge.

## Overview

This skill captures learnings immediately after problem resolution, writing them to Claude Code's native memory locations:

| Scope | Location | Description |
|-------|----------|-------------|
| Team | `.claude/rules/[category]/[topic].md` | Shared with team (git-tracked) |
| Personal | `.claude/local/rules/[category]/[topic].md` | Just you, this project |
| Global | `~/.claude/rules/[category]/[topic].md` | All your projects |

**Organization:** Rules are organized into emergent category subdirectories. Categories are generated by Claude based on content - not predefined.

---

<critical_sequence name="learning-capture" enforce_order="strict">

## 4-Phase Process

<step number="1" required="true">
### Phase 1: Extract Learnings (Parallel)

Launch parallel subagents to extract learnings from the session:

**Context Analyzer:**
- Extracts conversation history
- Identifies problem type, symptoms, investigation steps
- Returns: Learning candidates with titles and descriptions

**Solution Extractor:**
- Analyzes what worked and what didn't
- Identifies root cause and fix
- Returns: Solution content with code examples

**Prevention Strategist:**
- Develops prevention strategies
- Creates best practices guidance
- Returns: Prevention/pattern content

**Non-trivial problems only:**
- Multiple investigation attempts needed
- Tricky debugging that took time
- Non-obvious solution
- Future sessions would benefit

**Skip documentation for:**
- Simple typos
- Obvious syntax errors
- Trivial fixes immediately corrected
</step>

<step number="2" required="true" depends_on="1">
### Phase 2: Iterate Learnings (One at a Time)

For each extracted learning, use `AskUserQuestion` tool:

```
Learning: "[Title]"
[Brief 1-2 sentence description]

→ .claude/rules/[category]/[filename].md

Where should this rule live?
```

**Options (arrow key selection):**

| Option | Label | Description |
|--------|-------|-------------|
| 1 | Team (Recommended) | Shared with team via `.claude/rules/` |
| 2 | Personal | Just you, this project via `.claude/local/rules/` |
| 3 | Global | All your projects via `~/.claude/rules/` |
| 4 | Skip | Don't save this learning |

**Category and filename determined by Claude:**
- Analyze the learning content
- Determine a short, descriptive category (lowercase, single word or hyphenated)
- Check existing categories in target scope: `ls .claude/rules/`
- Reuse existing categories when appropriate
- Create new categories when the learning doesn't fit existing ones
- Generate filename from title (slugify, max 60 chars)

**Scope recommendation logic:**

| Signal | Recommended Scope |
|--------|-------------------|
| Project-specific pattern | Team (Recommended) |
| Personal preference/habit | Personal |
| Generic best practice | Global |

**Repeat for each learning.**
</step>

<step number="3" required="true" depends_on="2">
### Phase 3: Missed Anything?

After processing all extracted learnings, ask:

```
Did I miss any learnings from this session?
```

**Options:**
| Option | Label | Description |
|--------|-------|-------------|
| 1 | No, we're done | Proceed to write all rules |
| 2 | Yes, there's more | Describe what was missed |

**If yes:** User describes the missed learning, add to list, loop back to Phase 2 for that learning.

**If no:** Proceed to Phase 4.
</step>

<step number="4" required="true" depends_on="3">
### Phase 4: Write to Native Locations

For each learning that wasn't skipped:

1. **Determine target path:**
   - Team: `.claude/rules/[category]/[topic].md`
   - Personal: `.claude/local/rules/[category]/[topic].md`
   - Global: `~/.claude/rules/[category]/[topic].md`

2. **Ensure directory exists:**
   ```bash
   mkdir -p "[target_directory]"
   ```

3. **For Personal scope (first use):**
   - Create `.claude/local/rules/` directory
   - Add `.claude/local/` to project `.gitignore` if not present
   - Show confirmation: "Created .claude/local/rules/ and added to .gitignore"

4. **Write rule file** using template from [rule-template.md](./assets/rule-template.md)
</step>

</critical_sequence>

---

## Rule File Format

Use optional YAML frontmatter for path-scoping:

```markdown
---
paths:
  - "app/models/**/*.rb"
---

# [Rule Title]

[Clear description of the rule/pattern]

## Why

[Technical explanation of why this matters]

## Wrong

```[language]
[Example of incorrect approach]
```

## Correct

```[language]
[Example of correct approach]
```
```

**Frontmatter is optional.** Only include `paths:` when the rule applies to specific file patterns.

---

## Emergent Categories

Categories are **generated by Claude** based on content. No fixed list.

**Guidelines for determining category:**
1. Analyze the learning content
2. Determine a short, descriptive category (lowercase, single word or hyphenated)
3. Check existing categories: `ls .claude/rules/` (or target scope)
4. Reuse if learning fits an existing category
5. Create new if no good fit exists

**Example emergent categories:**
- `database` - queries, associations, migrations
- `controllers` - routes, params, responses
- `hotwire` - Turbo, Stimulus patterns
- `testing` - RSpec, factories
- `git` - commits, branches, PRs
- `security` - auth, tokens, permissions
- (new categories emerge as needed)

---

<integration_protocol>

## Integration Points

**Invoked by:**
- `/workflows:compound` command (primary interface)
- Manual invocation after solution confirmed
- Auto-triggered by confirmation phrases: "that worked", "it's fixed", etc.

**Invokes:**
- None (terminal skill)

**Handoff expectations:**
All context needed for documentation should be present in conversation history.

</integration_protocol>

---

<success_criteria>

## Success Criteria

Documentation is successful when ALL of the following are true:

- ✅ Learnings extracted from session via parallel subagents
- ✅ Each learning presented to user via AskUserQuestion
- ✅ User selected scope (Team/Personal/Global) or Skip for each
- ✅ "Missed anything?" loop completed
- ✅ Rule files created in correct native locations
- ✅ Categories are emergent (Claude-determined, reusing existing when appropriate)
- ✅ `.claude/local/` added to `.gitignore` if Personal scope used

</success_criteria>

---

## Error Handling

**Missing context:**
- Ask user for missing details
- Don't proceed until critical info provided

**Directory creation failure:**
- Show specific error
- Suggest manual directory creation

**Gitignore update failure:**
- Warn user to manually add `.claude/local/` to `.gitignore`

---

## Execution Guidelines

**MUST do:**
- Use AskUserQuestion for each learning (one at a time)
- Determine category automatically (don't ask user)
- Check existing categories before creating new ones
- Create directories before writing files (`mkdir -p`)
- Add `.claude/local/` to `.gitignore` on first Personal use

**MUST NOT do:**
- Ask user to choose category (Claude determines it)
- Write to old locations (`docs/solutions/`, `~/.claude/learnings/`)
- Skip the "Missed anything?" loop
- Batch multiple learnings into one AskUserQuestion

---

## Example Scenario

**User:** "That worked! The N+1 query is fixed."

**Phase 1 - Extract:**
Parallel subagents identify learning:
- Title: "N+1 Query Prevention"
- Description: "Always use includes() when iterating over associations"
- Category: `database` (determined by Claude)
- Filename: `eager-loading.md`

**Phase 2 - Ask User:**
```
Learning: "N+1 Query Prevention"
Always use includes() when iterating over associations.

→ .claude/rules/database/eager-loading.md

Where should this rule live?

○ Team (Recommended) - Shared with team via .claude/rules/
○ Personal - Just you, this project via .claude/local/rules/
○ Global - All your projects via ~/.claude/rules/
○ Skip - Don't save this learning
```

User selects: **Team**

**Phase 3 - Missed Anything?:**
```
Did I miss any learnings from this session?

○ No, we're done - Proceed to write all rules
○ Yes, there's more - Describe what was missed
```

User selects: **No, we're done**

**Phase 4 - Write:**
Creates `.claude/rules/database/eager-loading.md`:

```markdown
# Always Use Includes for Associations

When querying models with associations, always use `includes()` to eager-load.

## Why

Prevents N+1 queries that cause severe performance degradation.

## Wrong

```ruby
Brief.all.each { |b| b.emails.count }  # N+1!
```

## Correct

```ruby
Brief.includes(:emails).all.each { |b| b.emails.count }
```
```

**Output:**
```
✓ Learning captured

Created:
- .claude/rules/database/eager-loading.md

This rule will be applied to future sessions working with database code.
```
