# Plan: Upgrade /workflows:compound to Use Native Claude Code Memory

## Summary

Rewrite `/workflows:compound` to write directly to Claude Code's native memory system:
- `.claude/rules/*.md` for patterns/rules
- `CLAUDE.md` sections for key context
- `~/.claude/rules/` or `~/.claude/CLAUDE.md` for global learnings

**No backward compatibility** - migrate existing custom locations to native format.

## Official Claude Code Memory Locations

| Location | Purpose | Scope |
|----------|---------|-------|
| `./CLAUDE.md` | Project instructions | Team (git-tracked) |
| `./.claude/rules/*.md` | Modular topic rules | Team (git-tracked) |
| `./CLAUDE.local.md` | Personal project prefs | Just you (this project) |
| `./.claude/local/rules/*.md` | Personal project rules | Just you (this project) |
| `~/.claude/CLAUDE.md` | Global preferences | Just you (all projects) |
| `~/.claude/rules/*.md` | Global rules | Just you (all projects) |

**Scope parity:** Each scope has both a CLAUDE.md and rules/ directory.

## Files to Modify

1. `plugins/compound-engineering/commands/workflows/compound.md` - Rewrite for native memory
2. `plugins/compound-engineering/skills/compound-docs/SKILL.md` - Target native locations

## User Flow After Upgrade

```
/workflows:compound
        │
        ▼
┌────────────────────────────────┐
│  PHASE 1: PARALLEL EXTRACTION  │  (keep parallel subagents)
│  Extract learnings from session│
└────────────────────────────────┘
        │
        ▼
┌────────────────────────────────┐
│  PHASE 2: ITERATE LEARNINGS    │
│  (one at a time with arrows)   │
│                                │
│  For each extracted learning,  │
│  use AskUserQuestion tool:     │
│                                │
│  "Learning: [title]            │
│   [brief description]          │
│                                │
│   Where should this go?"       │
│                                │
│  Options (arrow key select):   │
│  - Team (.claude/rules/)       │
│  - Personal (.claude/local/)   │
│  - Global (~/.claude/rules/)   │
│  - Skip                        │
│                                │
│  Repeat for each learning.     │
└────────────────────────────────┘
        │
        ▼
┌────────────────────────────────┐
│  PHASE 3: MISSED ANYTHING?     │
│                                │
│  Ask: "Did I miss any          │
│  learnings from this session?" │
│                                │
│  If yes: user describes it,    │
│  loop back to Phase 2          │
│                                │
│  If no: proceed to write       │
└────────────────────────────────┘
        │
        ▼
┌────────────────────────────────┐
│  PHASE 4: WRITE TO NATIVE LOC  │
│                                │
│  Create .claude/rules/*.md     │
│  Create ~/.claude/rules/*.md   │
│  etc. based on selections      │
└────────────────────────────────┘
```

## Rule File Format

All rules organized into category subdirectories (consistent across all scopes):
- Team: `.claude/rules/[category]/[topic].md`
- Personal: `.claude/local/rules/[category]/[topic].md`
- Global: `~/.claude/rules/[category]/[topic].md`

### Rule Categories (Emergent)

Categories are **generated by Claude** based on content. No fixed list - new categories emerge naturally.

**Guidelines for Claude:**
1. Analyze the learning content
2. Determine a short, descriptive category (lowercase, single word or hyphenated)
3. Reuse existing categories in that scope when appropriate
4. Create new categories when the learning doesn't fit existing ones

**Example emergent categories:**
- `database` - queries, associations, migrations
- `controllers` - routes, params, responses
- `hotwire` - Turbo, Stimulus patterns
- `testing` - RSpec, factories
- `git` - commits, branches, PRs
- `security` - auth, tokens, permissions
- (new categories emerge as needed)

**Before creating a new category:**
1. Check existing categories: `ls .claude/rules/`
2. Reuse if learning fits an existing category
3. Create new if no good fit exists

Example paths:
- `.claude/rules/database/eager-loading.md`
- `~/.claude/rules/git/commit-messages.md`
- `.claude/rules/hotwire/turbo-frames.md`

Use optional YAML frontmatter for path-scoping:

```markdown
---
paths:
  - "app/models/**/*.rb"
---

# Always Use Includes for Associations

When querying models with associations, always use `includes()` to eager-load.

## Why

Prevents N+1 queries that cause severe performance degradation.

## Wrong

```ruby
Brief.all.each { |b| b.emails.count }  # N+1!
```

## Correct

```ruby
Brief.includes(:emails).all.each { |b| b.emails.count }
```
```

## Scope Selection (AskUserQuestion)

Each learning presented one at a time. Category is determined by Claude (user does not choose).

```
Learning: "N+1 Query Prevention"
Always use includes() when iterating over associations.

→ .claude/rules/database/eager-loading.md

Where should this rule live?
```

Options (arrow key selection):
| Option | Description | Path |
|--------|-------------|------|
| Team (Recommended) | Shared with team | `.claude/rules/database/` |
| Personal | Just you, this project | `.claude/local/rules/database/` |
| Global | All your projects | `~/.claude/rules/database/` |
| Skip | Don't save | — |

**Category and filename determined by Claude** based on content. User only chooses scope.

**Scope recommendation logic** (shown in option description):

| Signal | Recommended Scope |
|--------|-------------------|
| Project-specific pattern | Team (Recommended) |
| Personal preference/habit | Personal |
| Generic best practice | Global |

## Implementation Steps

### Step 1: Update compound-docs SKILL.md

Major rewrites:
1. Remove all `docs/solutions/` references
2. Remove complex YAML schema validation (simpler format)
3. Add emergent category logic:
   - Check existing categories in target scope: `ls .claude/rules/`
   - Claude decides best category (reuse existing or create new)
   - Generate filename from title (slugify, max 60 chars)
4. Add Phase 2: Use AskUserQuestion for each extracted learning
   - Show: title, description, auto-generated path
   - Options: Team, Personal, Global, Skip (arrow key selection)
   - User only chooses scope, not category
5. Add Phase 3: Ask "Did I miss any learnings?" loop
   - If yes: user describes it, add to list, loop back
   - If no: proceed to write
6. Write to `[scope]/rules/[category]/[topic].md`

### Step 2: Update workflows/compound.md command

1. Update purpose description - now handles both problem docs and learnings
2. Document new AskUserQuestion-based scope selection
3. Update success output examples
4. Remove references to separate `/learn` command

### Step 3: Create rule-template.md

Simple template for rules with optional path-scoping frontmatter.

### Step 4: Remove Old Files

- Delete `skills/compound-docs/schema.yaml`
- Delete `skills/compound-docs/assets/resolution-template.md`
- Delete `skills/compound-docs/references/yaml-schema.md`

### Step 5: Ensure Local Directory Setup & Gitignore

On first use, automatically:
1. Create `.claude/local/rules/` directory
2. Add `.claude/local/` to project `.gitignore` if not already present
3. Show confirmation: "Created .claude/local/rules/ and added to .gitignore"

### Step 6: Migration Script (Optional)

One-time migration to convert:
- `docs/solutions/*.md` → `.claude/rules/*.md`
- `~/.claude/learnings/*.md` → `~/.claude/rules/*.md`

### Step 7: Delete /learn Command

Remove `~/.claude/commands/learn.md` - its functionality is now merged into `/workflows:compound`.

## Files to Delete

- `plugins/compound-engineering/skills/compound-docs/schema.yaml`
- `plugins/compound-engineering/skills/compound-docs/assets/resolution-template.md`
- `plugins/compound-engineering/skills/compound-docs/references/yaml-schema.md`
- `~/.claude/commands/learn.md` (merged into /compound)

## Files to Create

- `plugins/compound-engineering/skills/compound-docs/assets/rule-template.md`

## Verification

1. Run `/workflows:compound` after solving a problem
2. Verify learnings presented one at a time via AskUserQuestion
3. Verify auto-detected category in path (e.g., `data/eager-loading.md`)
4. Verify scope selection works (Team/Personal/Global/Skip)
5. Test each scope creates correct path:
   - Team → `.claude/rules/[category]/[topic].md`
   - Personal → `.claude/local/rules/[category]/[topic].md`
   - Global → `~/.claude/rules/[category]/[topic].md`
6. Verify Skip → no file created
7. Verify "Did I miss any?" loop works
8. Verify `.claude/local/` added to `.gitignore` on first Personal use
9. Verify `/learn` command no longer exists
10. Verify no writes to old locations (`docs/solutions/`, `~/.claude/learnings/`)
